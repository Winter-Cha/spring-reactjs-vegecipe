<!-- comment template -->
<div class="card card-widget" id="comment-card-widget">
    <div class="card-header">
        <h3 class="card-title"><i class="far fa-comments mr-1"></i>Comment ({{commentTotCnt}})</h3>
        <div class="card-tools">
            <!--<button type="button" class="btn btn-tool" data-toggle="tooltip" title="Mark as read">
            <i class="far fa-circle"></i></button>-->
            <button type="button" class="btn btn-tool" data-card-widget="collapse"><i class="fas fa-minus"></i>
            </button>
            <!--<button type="button" class="btn btn-tool" data-card-widget="remove"><i class="fas fa-times"></i>
        </button>-->
        </div>
        <!-- /.card-tools -->
    </div>
    <!-- /.card-header-->

    {{#comments.content}}
    <!-- /.card-header -->
    <div class="card-footer card-comments">
        <div class="card-comment border-bottom">
            <div class="comment-text " style="margin-left:0;">
                <span class="username" style="margin-left:0;">
                    {{author}}
                    <button type="button" class="btn btn-outline-default btn-xs float-right" onclick="javascript:fn_v_toggle_comment_delete({{id}})"><i class="far fa-trash-alt"></i></button>
                    <span class="text-muted float-right">{{createdDate}}</span>
                </span><!-- /.username -->
                <p class="text-justify" style="white-space: pre-wrap;">{{text}}</p>
            </div>
            <!-- /.comment-text -->
            <div class="input-group input-group-sm mb-0" id="group-delete-comment{{id}}" style="display:none;">
                <div class="input-group mb-3">
                    <input type="password" class="form-control-sm" maxlength="10" placeholder="Password" id="delete-comment-password{{id}}" />
                    <div class="input-group-append">
                        <div class="input-group-text">
                            <span class="fas fa-lock"></span>
                        </div>
                    </div>
                    <button type="button" class="btn btn-outline-danger btn-sm" onclick="javascript:fn_v_confirm_comment_delete({{id}})"><i class="fas fa-pen-square"></i> 삭제</button>
                    <button type="button" class="btn btn-outline-default btn-sm" onclick="javascript:fn_v_cancel_comment_delete({{id}})"><i class="fas fa-window-close"></i></button>
                </div>
            </div>
        </div>
        <!-- /.card-comment -->
    </div>
    <!-- /.card-footer -->
    {{/comments.content}}

    <!-- /.card-footer Comment 입력 (로그인)-->
    <div class="card-footer">
        <form role="form" id="commentWriteForm">
            <input type="hidden" id="postId" name="postId" value="{{postId}}"/>
            <!-- .img-push is used to add margin to elements next to floating images -->
            <div class="input-group input-group-sm mb-0">
                <div class="input-group mb-3">
                    <textarea class="form-control" name="reportCn" rows="3"
                              onkeyup="javascript:fn_TextAreaInputLimit();" placeholder="소중한 나의 의견을 남겨주세요 ..."
                              id="comment"></textarea>
                </div>
                <div class="input-group">
                    <input type="password" class="form-control-sm" maxlength="10" placeholder="Password" id="comment-password" />
                    <div class="input-group-append">
                        <div class="input-group-text">
                            <span class="fas fa-lock"></span>
                        </div>
                    </div>
                    <div class="input-group-append float-right">
                        <div class="input-group-button">
                            <button type="button" class="btn btn-outline-info btn-sm" id="btn-comment-save"><i class="fas fa-pen-square"></i> 등록</button>
                        </div>
                    </div>
                </div>
                <p style="font-size:8px;">&nbsp;&nbsp;(댓글 삭제시 필요합니다)</p>
            </div>
        </form>
    </div>
</div>
        <!-- /.card card-widget -->


<script src="js/app/comment.js"></script>

<script type="text/javascript">

    $(document).ready(function () {
        //$('#comment-card-widget').CardWidget('toggle');         // 댓글 접기 토글
    });


    // TEXTAREA 최대값 체크
    function fn_TextAreaInputLimit() {
        var tempText = $("textarea[name='reportCn']");
        var tempChar = "";                                        // TextArea의 문자를 한글자씩 담는다
        var tempChar2 = "";                                        // 절삭된 문자들을 담기 위한 변수
        var countChar = 0;                                        // 한글자씩 담긴 문자를 카운트 한다
        var tempHangul = 0;                                        // 한글을 카운트 한다
        var maxSize = 400;                                        // 최대값

        // 글자수 바이트 체크를 위한 반복
        for(var i = 0 ; i < tempText.val().length; i++) {
            tempChar = tempText.val().charAt(i);

            // 한글일 경우 2 추가, 영문일 경우 1 추가
            if(escape(tempChar).length > 4) {
                countChar += 2;
                tempHangul++;
            } else {
            countChar++;
        }
    }

    // 카운트된 문자수가 MAX 값을 초과하게 되면 절삭 수치까지만 출력을 한다.(한글 입력 체크)
    // 내용에 한글이 입력되어 있는 경우 한글에 해당하는 카운트 만큼을 전체 카운트에서 뺀 숫자가 maxSize보다 크면 수행
    if((countChar-tempHangul) > maxSize) {
        alert("최대 글자수를 초과하였습니다.");

        tempChar2 = tempText.val().substr(0, maxSize-1);
        tempText.val(tempChar2);
    }
    }

    // 댓글 삭제
    function fn_v_confirm_comment_delete(commentId){
        var password = $("#delete-comment-password"+commentId ).val();

        var data = {
            commentId: commentId,
            password: $("#delete-comment-password"+commentId ).val(),
        };
        var postId = $('#postId').val();
        if(!data.password.trim()){
            alert("비밀번호을 입력하세요.");
            return;
        }

        $.ajax({
            type: 'DELETE',
            url: '/api/v1/post/'+ postId + '/comments/' + commentId ,
            dataType: 'json',
            contentType: 'application/json; charset=utf-8',
            data: JSON.stringify(data)
        }).done(function(){
            //alert('삭제되었습니다.');
            //window.location.href = '/community';
        }).fail(function (error) {
            if(error.status == 200){
                alert('삭제되었습니다.');
                var postId = $('#postId').val();
                fm_v_get_comments(postId);
            } else if(error.status == 999){
                alert('비밀번호가 틀립니다.');
            } else {
                alert('죄송합니다. 오류가 발생하였습니다!');
                //alert(JSON.stringify(error));
            }
        });
    };

    // 삭제 버튼 클릭 이벤트 핸들러
    function fn_v_toggle_comment_delete(commentId){
        $( "#group-delete-comment"+commentId ).show();
    };

    // 삭제 버튼 취소 클릭 이벤트 핸들러
    function fn_v_cancel_comment_delete(commentId){
        $( "#group-delete-comment"+commentId ).hide();
    };

    // 댓글 리스트 다시 조회
    function fm_v_get_comments(postId){
        var ajaxUrl = "/api/v1/post/" + postId + "/comments";

        $.ajax({
            type: "GET",
            url: ajaxUrl,
            success: function(response) {
                $("#comment-target").html( response );
            }
        });
    };
</script>